# Lab 1.1.2: Sidecar Pattern - Multi-Container Pods

> Learn how containers in a pod share resources by building a real sidecar pattern

---

## What We're Building

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           SIDECAR PATTERN                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────┐     │
│   │                          POD                                  │     │
│   │                                                               │     │
│   │   ┌─────────────────┐         ┌─────────────────┐             │     │
│   │   │  Main Container │         │Sidecar Container│             │     │
│   │   │     (nginx)     │         │   (log-reader)  │             │     │
│   │   │                 │         │                 │             │     │
│   │   │  Writes logs    │         │  Reads logs     │             │     │
│   │   │  to volume      │         │  from volume    │             │     │
│   │   └────────┬────────┘         └────────┬────────┘             │     │
│   │            │                           │                      │     │
│   │            ▼                           ▼                      │     │
│   │   ┌─────────────────────────────────────────────┐             │     │
│   │   │            SHARED VOLUME                    │             │     │
│   │   │         /var/log/nginx                      │             │     │
│   │   └─────────────────────────────────────────────┘             │     │
│   │                                                               │     │
│   │   Both containers:                                            │     │
│   │   • Share the same network (localhost)                        │     │
│   │   • Share the same volume                                     │     │
│   │   • Start and stop together                                   │     │
│   │                                                               │     │
│   └───────────────────────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Prerequisites

- Podman Desktop running (`podman machine start`)
- A kind cluster running
- kubectl configured

---

## Lab 1: Basic Sidecar - Shared Volume

### Step 1: Create the sidecar pod manifest

```bash
cat << 'EOF' > /tmp/sidecar-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sidecar-demo
  labels:
    app: sidecar-demo
spec:
  containers:
    # Main container: nginx web server
    - name: nginx
      image: nginx:1.25
      ports:
        - containerPort: 80
      volumeMounts:
        - name: shared-logs
          mountPath: /var/log/nginx

    # Sidecar container: reads and displays logs
    - name: log-reader
      image: busybox:1.36
      command: ["sh", "-c", "tail -f /var/log/nginx/access.log 2>/dev/null || sleep infinity"]
      volumeMounts:
        - name: shared-logs
          mountPath: /var/log/nginx

  # Shared volume between containers
  volumes:
    - name: shared-logs
      emptyDir: {}
EOF
```

### Step 2: Apply and verify

```bash
# Create the pod
kubectl apply -f /tmp/sidecar-pod.yaml

# Wait for pod to be ready (2/2 means both containers running)
kubectl get pods -w

# Expected output:
# NAME           READY   STATUS    RESTARTS   AGE
# sidecar-demo   2/2     Running   0          30s
```

### Step 3: Generate some traffic

```bash
# Port forward to access nginx
kubectl port-forward pod/sidecar-demo 8080:80 &

# Generate requests (this creates log entries)
curl http://localhost:8080
curl http://localhost:8080
curl http://localhost:8080

# Stop port-forward
kill %1
```

### Step 4: See the sidecar reading logs

```bash
# View logs from the sidecar container
kubectl logs sidecar-demo -c log-reader

# Expected output - sidecar sees nginx's logs:
# 127.0.0.1 - - [26/Jan/2026:10:00:00 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.1.2"
# 127.0.0.1 - - [26/Jan/2026:10:00:01 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.1.2"
```

**Key insight:** The sidecar container can read files written by the main container via shared volume!

### Step 5: Explore both containers

```bash
# Shell into nginx container
kubectl exec -it sidecar-demo -c nginx -- /bin/sh
ls /var/log/nginx/
cat /var/log/nginx/access.log
exit

# Shell into sidecar container
kubectl exec -it sidecar-demo -c log-reader -- /bin/sh
ls /var/log/nginx/
cat /var/log/nginx/access.log
exit
```

Both containers see the same files!

### Step 6: Cleanup

```bash
kubectl delete pod sidecar-demo
```

---

## Lab 2: Localhost Communication Between Containers

This lab demonstrates that containers in a pod share the network namespace.

### Step 1: Create a pod with two web servers

```bash
cat << 'EOF' > /tmp/localhost-demo.yaml
apiVersion: v1
kind: Pod
metadata:
  name: localhost-demo
  labels:
    app: localhost-demo
spec:
  containers:
    # Container 1: nginx on port 80
    - name: nginx
      image: nginx:1.25
      ports:
        - containerPort: 80

    # Container 2: busybox running a simple HTTP server on port 8080
    - name: http-server
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "Hello from sidecar!" > /tmp/index.html
          httpd -f -p 8080 -h /tmp
      ports:
        - containerPort: 8080
EOF
```

### Step 2: Apply and test

```bash
# Create the pod
kubectl apply -f /tmp/localhost-demo.yaml

# Wait for both containers
kubectl get pods localhost-demo -w
```

### Step 3: Prove containers share localhost

```bash
# Exec into nginx and curl the OTHER container via localhost
kubectl exec -it localhost-demo -c nginx -- curl localhost:8080

# Output:
# Hello from sidecar!

# Exec into http-server (busybox) and wget nginx via localhost
kubectl exec -it localhost-demo -c http-server -- wget -qO- localhost:80

# Output:
# <!DOCTYPE html>
# <html>
# <head>
# <title>Welcome to nginx!</title>
# ...
```

**Key insight:** Both containers share the same network - they can talk via `localhost`!

### Step 4: Check they share the same IP

```bash
# Get pod IP
kubectl get pod localhost-demo -o wide

# Verify from inside each container
kubectl exec localhost-demo -c nginx -- hostname -i
kubectl exec localhost-demo -c http-server -- hostname -i

# Both return the same IP!
```

### Step 5: Cleanup

```bash
kubectl delete pod localhost-demo
```

---

## Lab 3: Real-World Sidecar - Content Sync

A common pattern: sidecar that syncs content for the main app.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      CONTENT SYNC SIDECAR                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────┐     │
│   │                          POD                                  │     │
│   │                                                               │     │
│   │   ┌─────────────────┐         ┌─────────────────┐             │     │
│   │   │     nginx       │         │   git-sync      │             │     │
│   │   │  (serves HTML)  │         │ (pulls content) │             │     │
│   │   └────────┬────────┘         └────────┬────────┘             │     │
│   │            │                           │                      │     │
│   │            ▼                           ▼                      │     │
│   │   ┌─────────────────────────────────────────────┐             │     │
│   │   │          /usr/share/nginx/html              │             │     │
│   │   │     (git-sync writes, nginx serves)         │             │     │
│   │   └─────────────────────────────────────────────┘             │     │
│   │                                                               │     │
│   └───────────────────────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Step 1: Create the content-sync pod

```bash
cat << 'EOF' > /tmp/content-sync.yaml
apiVersion: v1
kind: Pod
metadata:
  name: content-sync
  labels:
    app: content-sync
spec:
  containers:
    # Main container: serves content
    - name: nginx
      image: nginx:1.25
      ports:
        - containerPort: 80
      volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html

    # Sidecar: updates content every 10 seconds
    - name: content-updater
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "<html><body><h1>Update #$COUNT</h1><p>Last updated: $(date)</p></body></html>" > /html/index.html
            echo "Updated content to version $COUNT"
            sleep 10
          done
      volumeMounts:
        - name: html
          mountPath: /html

  volumes:
    - name: html
      emptyDir: {}
EOF
```

### Step 2: Apply and watch

```bash
# Create the pod
kubectl apply -f /tmp/content-sync.yaml

# Watch the sidecar updating content
kubectl logs -f content-sync -c content-updater
```

### Step 3: See content changing

```bash
# In another terminal, port-forward
kubectl port-forward pod/content-sync 8080:80 &

# Curl multiple times - content changes!
curl http://localhost:8080
sleep 12
curl http://localhost:8080

# Output shows different update numbers and timestamps!

# Stop port-forward
kill %1
```

### Step 4: Cleanup

```bash
kubectl delete pod content-sync
```

---

## Lab 4: Init Container + Sidecar

Init containers run BEFORE the main containers start. Combined with sidecars, they're powerful.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    INIT CONTAINER + SIDECAR                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   STARTUP SEQUENCE:                                                     │
│                                                                         │
│   1. Init Container runs first (prepares content)                       │
│      ┌─────────────────┐                                                │
│      │  init-content   │ ──▶ Writes initial HTML ──▶ Exits (success)    │
│      └─────────────────┘                                                │
│                │                                                        │
│                ▼                                                        │
│   2. Main containers start (after init completes)                       │
│      ┌─────────────────┐    ┌─────────────────┐                         │
│      │     nginx       │    │   log-reader    │                         │
│      │  (serves HTML)  │    │  (watches logs) │                         │
│      └─────────────────┘    └─────────────────┘                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Step 1: Create pod with init container

```bash
cat << 'EOF' > /tmp/init-sidecar.yaml
apiVersion: v1
kind: Pod
metadata:
  name: init-sidecar-demo
  labels:
    app: init-sidecar-demo
spec:
  # Init container runs first
  initContainers:
    - name: init-content
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "Init container starting..."
          echo "<html><body><h1>Initialized by init container!</h1><p>Time: $(date)</p></body></html>" > /html/index.html
          echo "Init container done!"
      volumeMounts:
        - name: html
          mountPath: /html

  # Main containers start after init completes
  containers:
    - name: nginx
      image: nginx:1.25
      ports:
        - containerPort: 80
      volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
        - name: logs
          mountPath: /var/log/nginx

    - name: log-reader
      image: busybox:1.36
      command: ["sh", "-c", "tail -f /var/log/nginx/access.log 2>/dev/null || sleep infinity"]
      volumeMounts:
        - name: logs
          mountPath: /var/log/nginx

  volumes:
    - name: html
      emptyDir: {}
    - name: logs
      emptyDir: {}
EOF
```

### Step 2: Apply and observe startup

```bash
# Apply
kubectl apply -f /tmp/init-sidecar.yaml

# Watch the startup sequence
kubectl get pods init-sidecar-demo -w

# You'll see:
# NAME                READY   STATUS     RESTARTS   AGE
# init-sidecar-demo   0/2     Init:0/1   0          1s
# init-sidecar-demo   0/2     Init:0/1   0          2s
# init-sidecar-demo   0/2     PodInitializing   0   3s
# init-sidecar-demo   2/2     Running    0          5s
```

### Step 3: Verify init container ran

```bash
# Check init container logs
kubectl logs init-sidecar-demo -c init-content

# Output:
# Init container starting...
# Init container done!

# Verify content was initialized
kubectl exec init-sidecar-demo -c nginx -- cat /usr/share/nginx/html/index.html

# Output shows content created by init container
```

### Step 4: Cleanup

```bash
kubectl delete pod init-sidecar-demo
```

---

## Common Sidecar Patterns Summary

| Pattern | Main Container | Sidecar | Shared Resource |
|---------|----------------|---------|-----------------|
| **Log shipping** | App writes logs | Fluentd/Filebeat ships logs | Volume |
| **Proxy** | App | Envoy/Nginx proxy | Network (localhost) |
| **Config sync** | App reads config | Git-sync updates config | Volume |
| **Secrets** | App reads secrets | Vault-agent refreshes | Volume |
| **Monitoring** | App | Prometheus exporter | Network (localhost) |

---

## What Containers Share - Verified

After these labs, you've proven:

| Resource | How We Verified |
|----------|-----------------|
| **Volumes** | Lab 1, 3, 4: Both containers read/write same files |
| **Network** | Lab 2: curl localhost between containers |
| **IP Address** | Lab 2: hostname -i returns same IP |
| **Lifecycle** | All labs: READY shows X/X when all containers run |

---

## Key Takeaways

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         SIDECAR SUMMARY                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Containers in a pod share:                                             │
│  • Network namespace (localhost, same IP)                               │
│  • Volumes (explicitly mounted)                                         │
│  • Lifecycle (start/stop together)                                      │
│                                                                         │
│  Use sidecars when:                                                     │
│  • Helper functionality (logging, monitoring, proxy)                    │
│  • Tight coupling required                                              │
│  • Shared files or localhost communication needed                       │
│                                                                         │
│  Don't use sidecars when:                                               │
│  • Containers can scale independently                                   │
│  • They're separate services                                            │
│                                                                         │
│  Init containers:                                                       │
│  • Run before main containers                                           │
│  • Good for setup/initialization                                        │
│  • Must complete successfully for pod to start                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Cleanup All

```bash
kubectl delete pod sidecar-demo localhost-demo content-sync init-sidecar-demo 2>/dev/null
```

---

## Related

- [1.1 What is a Pod](1.1_what_is_a_pod.md) — Pod concepts
- [1.1.1 Node Failure Lab](1.1.1_node_failure_lab.md) — Node failure experiments

---

*Lab 1.1.2 of Kubernetes 101: From Zero to Production*
