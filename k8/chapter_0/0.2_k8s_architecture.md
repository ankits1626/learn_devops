# 0.2 Kubernetes Architecture

## What is a Kubernetes Cluster?

Let's start with a simple analogy.

### Think of a Restaurant

```text
┌─────────────────────────────────────────────────────────────┐
│                      A RESTAURANT                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Manager's Office              Kitchen                     │
│   ┌─────────────────┐          ┌─────────────────┐          │
│   │                 │          │  Chef 1         │          │
│   │  • Takes orders │          │  Chef 2         │          │
│   │  • Assigns work │  ──────▶ │  Chef 3         │          │
│   │  • Tracks status│          │                 │          │
│   │                 │          │  (Actually cook │          │
│   │ (Makes decisions│          │   the food)     │          │
│   │  but doesn't    │          │                 │          │
│   │  cook)          │          │                 │          │
│   └─────────────────┘          └─────────────────┘          │
│                                                             │
│   The whole restaurant = working together as ONE unit       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**A Kubernetes cluster is like this restaurant:**

| Restaurant | Kubernetes Cluster |
|------------|-------------------|
| The whole restaurant | The cluster |
| Manager's office | Control Plane |
| Kitchen with chefs | Worker Nodes |
| Individual chefs | Individual nodes (machines) |
| Dishes being prepared | Pods (your containers) |
| Recipes | Your YAML configurations |

### A Cluster = A Group of Computers Working Together

```text
┌─────────────────────────────────────────────────────────────┐
│                  KUBERNETES CLUSTER                         │
│                                                             │
│    Just a fancy name for:                                   │
│    "Multiple computers connected together,                  │
│     managed as ONE system"                                  │
│                                                             │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│   │Computer │  │Computer │  │Computer │  │Computer │        │
│   │    1    │──│    2    │──│    3    │──│    4    │        │
│   │         │  │         │  │         │  │         │        │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
│        │            │            │            │             │
│        └────────────┴────────────┴────────────┘             │
│                          │                                  │
│                   All connected via                         │
│                      network                                │
│                                                             │
│   You talk to them as ONE thing, not 4 separate machines    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Why "Cluster"?

The word "cluster" means "a group of similar things close together" - like a cluster of grapes.

```text
Single Computer                    Cluster of Computers
┌─────────────┐                   ┌─────────────────────────┐
│             │                   │  ┌───┐ ┌───┐ ┌───┐      │
│   One       │                   │  │ 1 │ │ 2 │ │ 3 │      │
│   machine   │        vs         │  └───┘ └───┘ └───┘      │
│             │                   │     └───┴───┴───┘       │
│             │                   │    Working together     │
└─────────────┘                   └─────────────────────────┘

If it fails,                      If one fails,
everything stops                  others keep running!
```

**Benefits of a cluster:**
- **Reliability** - One machine dies? Others keep working
- **Scalability** - Need more power? Add more machines
- **Distribution** - Spread work across multiple machines

---

## The Big Picture

A Kubernetes cluster has two main parts:

```text
┌─────────────────────────────────────────────────────────────┐
│                    KUBERNETES CLUSTER                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌───────────────────────────────────────────────────┐     │
│   │            CONTROL PLANE (The Brain)              │     │
│   │                                                   │     │
│   │   Decides WHAT should run and WHERE               │     │
│   │   You talk to it via kubectl                      │     │
│   └───────────────────────────────────────────────────┘     │
│                          │                                  │
│                          │ Instructions                     │
│                          ▼                                  │
│   ┌───────────────────────────────────────────────────┐     │
│   │              WORKER NODES (The Muscle)            │     │
│   │                                                   │     │
│   │   Actually RUN your containers                    │     │
│   │   Could be VMs, physical servers, or cloud        │     │
│   └───────────────────────────────────────────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Control Plane** = The brain that makes decisions
**Worker Nodes** = The muscle that does the work

---

## What is a Node?

A **node** is simply a machine (computer) in your Kubernetes cluster.

```text
┌─────────────────────────────────────────────────────────────┐
│                      WHAT IS A NODE?                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   A node can be:                                            │
│                                                             │
│   • A physical server in a data center                      │
│   • A virtual machine (VM) in the cloud (EC2, GCE, etc.)    │
│   • A VM on your laptop (what kind does)                    │
│   • Even a Raspberry Pi!                                    │
│                                                             │
│   Each node has:                                            │
│   • CPU (processing power)                                  │
│   • Memory (RAM)                                            │
│   • Storage (disk)                                          │
│   • Network connection                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Types of Nodes

| Node Type | Role | How Many? |
|-----------|------|-----------|
| **Control Plane Node** | Runs the "brain" components (API Server, Scheduler, etc.) | Usually 1-3 |
| **Worker Node** | Runs your application containers | As many as you need |

```text
┌─────────────────────────────────────────────────────────────┐
│                    EXAMPLE CLUSTER                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Control Plane Node          Worker Nodes                  │
│   ┌─────────────────┐        ┌─────────────────┐            │
│   │  API Server     │        │  Your App       │            │
│   │  Scheduler      │───────▶│  Containers     │            │
│   │  Controller     │        │  run here       │            │
│   │  etcd           │        └─────────────────┘            │
│   └─────────────────┘        ┌─────────────────┐            │
│                              │  More Apps      │            │
│   (Makes decisions)   ──────▶│  run here       │            │
│                              └─────────────────┘            │
│                              ┌─────────────────┐            │
│                       ──────▶│  Even more      │            │
│                              │  containers     │            │
│                              └─────────────────┘            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**In our local setup with kind:** Each "node" is actually a Docker/Podman container pretending to be a server. To Kubernetes, they look like real nodes!

---

## Control Plane Components

The Control Plane is the "brain" of Kubernetes. It has 4 main components:

```text
┌─────────────────────────────────────────────────────────────┐
│                     CONTROL PLANE                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐          ┌──────────────┐                │
│   │  API Server  │          │   Scheduler  │                │
│   │              │          │              │                │
│   │  Front door  │          │  Decides     │                │
│   │  to cluster  │          │  where pods  │                │
│   │              │          │  run         │                │
│   └──────────────┘          └──────────────┘                │
│                                                             │
│   ┌──────────────┐          ┌──────────────┐                │
│   │  Controller  │          │    etcd      │                │
│   │   Manager    │          │              │                │
│   │              │          │  Database    │                │
│   │  Watches &   │          │  stores all  │                │
│   │  fixes state │          │  cluster     │                │
│   │              │          │  state       │                │
│   └──────────────┘          └──────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

Let's understand each one:

---

### 1. API Server (kube-apiserver)

**The front door to Kubernetes.**

Everything talks through the API Server - kubectl, dashboards, other components, even internal K8s processes.

```text
┌──────────────────────────────────────────────────────────────┐
│                      API SERVER                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│   kubectl ─────┐                                             │
│                │                                             │
│   Dashboard ───┼────▶ [API Server] ────▶ etcd                │
│                │           │                                 │
│   Other apps ──┘           │                                 │
│                            ▼                                 │
│                    Other components                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

What it does:

- **Validates requests** - Is this YAML correct? Do you have permission?
- **Authentication** - Who are you?
- **Authorization** - Are you allowed to do this?
- **REST API** - Everything is an API call (GET, POST, DELETE)

```bash
# When you run:
kubectl get pods

# Behind the scenes:
# 1. kubectl sends HTTP GET to API Server
# 2. API Server authenticates you
# 3. API Server queries etcd
# 4. Returns response to kubectl
```

---

### 2. Scheduler (kube-scheduler)

**Decides WHERE pods run.**

When you create a pod, the Scheduler picks the best node for it.

```text
┌─────────────────────────────────────────────────────────────┐
│                      SCHEDULER                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   New pod needs scheduling                                  │
│            │                                                │
│            ▼                                                │
│   ┌─────────────────────────────────────────┐               │
│   │  Which node should run this pod?        │               │
│   │                                         │               │
│   │  Consider:                              │               │
│   │  • Available CPU/Memory                 │               │
│   │  • Node selectors & affinity rules      │               │
│   │  • Taints and tolerations               │               │
│   │  • Data locality                        │               │
│   └─────────────────────────────────────────┘               │
│            │                                                │
│            ▼                                                │
│   "Put this pod on Node 2"                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

Example decision process:

```text
Pod requests: 500MB RAM, 0.5 CPU

Node 1: 200MB free  ❌ Not enough memory
Node 2: 1GB free    ✅ Has capacity
Node 3: 800MB free  ✅ Has capacity, but Node 2 has more room

Decision: Schedule on Node 2
```

**Important:** The Scheduler only DECIDES where to run. It doesn't actually start the pod - that's the kubelet's job.

---

### 3. Controller Manager (kube-controller-manager)

**Watches and fixes things.**

Controllers are control loops that watch the state of your cluster and make changes to move the current state toward the desired state.

```text
┌─────────────────────────────────────────────────────────────┐
│                  CONTROLLER MANAGER                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Contains multiple controllers:                            │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  ReplicaSet Controller                              │   │
│   │  "You said 3 replicas, only 2 running"              │   │
│   │  → Creates 1 more pod                               │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Node Controller                                    │   │
│   │  "Node 3 stopped responding for 5 minutes"          │   │
│   │  → Mark node as unhealthy, reschedule pods          │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Job Controller                                     │   │
│   │  "This batch job finished"                          │   │
│   │  → Mark as complete, clean up                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Endpoint Controller                                │   │
│   │  "New pod matches this service selector"            │   │
│   │  → Add pod IP to service endpoints                  │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

The control loop pattern:

```text
     ┌──────────────────────────────────────┐
     │                                      │
     ▼                                      │
┌─────────┐    ┌─────────┐    ┌─────────┐  │
│ Observe │───▶│ Compare │───▶│  Act    │──┘
│ Current │    │ Desired │    │         │
│  State  │    │   vs    │    │ Fix the │
│         │    │ Current │    │  Diff   │
└─────────┘    └─────────┘    └─────────┘

This loop runs continuously (every few seconds)
```

---

### 4. etcd

**The database - stores ALL cluster state.**

etcd is a distributed key-value store. It's the single source of truth for the cluster.

```text
┌─────────────────────────────────────────────────────────────┐
│                         etcd                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   Stores everything:                                         │
│                                                              │
│   /registry/pods/default/nginx-abc123                       │
│   /registry/services/default/my-service                     │
│   /registry/deployments/default/my-app                      │
│   /registry/secrets/default/db-password                     │
│   /registry/configmaps/default/app-config                   │
│   /registry/nodes/worker-1                                  │
│   ...                                                        │
│                                                              │
│   Key features:                                              │
│   • Distributed (multiple copies for reliability)           │
│   • Consistent (all nodes see the same data)                │
│   • Highly available (survives node failures)               │
│   • Watch support (get notified of changes)                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Critical:** If etcd dies and you have no backup, you lose your entire cluster state. In production, etcd is always replicated (usually 3 or 5 copies).

---

## Worker Node Components

Each worker node runs your actual containers:

```text
┌─────────────────────────────────────────────────────────────┐
│                      WORKER NODE                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌──────────────┐          ┌──────────────┐                │
│   │   kubelet    │          │  kube-proxy  │                │
│   │              │          │              │                │
│   │  Agent that  │          │  Handles     │                │
│   │  manages     │          │  networking  │                │
│   │  pods on     │          │  for pods    │                │
│   │  this node   │          │              │                │
│   └──────────────┘          └──────────────┘                │
│                                                              │
│   ┌──────────────────────────────────────────────────────┐  │
│   │              Container Runtime                        │  │
│   │                                                       │  │
│   │  containerd or CRI-O                                  │  │
│   │  Actually runs the containers                         │  │
│   └──────────────────────────────────────────────────────┘  │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                     PODS                             │   │
│   │   ┌─────────┐   ┌─────────┐   ┌─────────┐           │   │
│   │   │  nginx  │   │   api   │   │   db    │           │   │
│   │   └─────────┘   └─────────┘   └─────────┘           │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 1. kubelet

**Agent running on every node.**

The kubelet is the "node manager". It:

- Talks to the API Server: "What should I run?"
- Manages container lifecycle on this node
- Reports node status back to Control Plane
- Executes health checks

```text
┌─────────────────────────────────────────────────────────────┐
│                       kubelet                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   API Server: "Run pod nginx on this node"                  │
│        │                                                     │
│        ▼                                                     │
│   kubelet receives instruction                              │
│        │                                                     │
│        ▼                                                     │
│   kubelet tells container runtime: "Start nginx container"  │
│        │                                                     │
│        ▼                                                     │
│   Container starts                                          │
│        │                                                     │
│        ▼                                                     │
│   kubelet monitors health, reports back to API Server       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 2. kube-proxy

**Handles networking for pods.**

kube-proxy enables Kubernetes Services to work. It maintains network rules that allow communication to your pods.

```text
┌─────────────────────────────────────────────────────────────┐
│                      kube-proxy                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   Service: my-service (10.96.0.100:80)                      │
│        │                                                     │
│        │  Maps to pods:                                      │
│        │  - pod-1 (10.244.1.5:8080)                         │
│        │  - pod-2 (10.244.2.3:8080)                         │
│        │  - pod-3 (10.244.1.8:8080)                         │
│        │                                                     │
│        ▼                                                     │
│   kube-proxy creates rules:                                 │
│   "Traffic to 10.96.0.100:80 → load balance to pod IPs"    │
│                                                              │
│   Modes:                                                     │
│   • iptables (default) - Linux firewall rules              │
│   • IPVS - More efficient for large clusters               │
│   • userspace - Legacy, rarely used                        │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

### 3. Container Runtime

**Actually runs containers.**

Kubernetes doesn't run containers directly. It uses a container runtime that implements the Container Runtime Interface (CRI).

```text
┌─────────────────────────────────────────────────────────────┐
│                   CONTAINER RUNTIME                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   kubelet                                                    │
│      │                                                       │
│      │ CRI (Container Runtime Interface)                    │
│      ▼                                                       │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  containerd  │  CRI-O  │  Docker (deprecated)       │   │
│   └─────────────────────────────────────────────────────┘   │
│      │                                                       │
│      │ OCI (Open Container Initiative)                      │
│      ▼                                                       │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                    runc                              │   │
│   │            (actually creates containers)             │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**Note:** Docker as a runtime was deprecated in K8s 1.20 and removed in 1.24. Modern K8s uses containerd or CRI-O. Your Docker images still work fine - they're just OCI images.

---

## What is a Pod?

The **smallest deployable unit** in Kubernetes. Not a container - a Pod.

```text
┌─────────────────────────────────────────────────────────────┐
│                           POD                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   A Pod wraps one or more containers:                       │
│                                                              │
│   Most common: 1 Pod = 1 Container                          │
│   ┌───────────────────────────────────────┐                 │
│   │               Pod                      │                 │
│   │   ┌───────────────────────────────┐   │                 │
│   │   │         my-app                │   │                 │
│   │   │       (container)             │   │                 │
│   │   └───────────────────────────────┘   │                 │
│   └───────────────────────────────────────┘                 │
│                                                              │
│   Sometimes: 1 Pod = Multiple Containers (sidecar pattern)  │
│   ┌───────────────────────────────────────┐                 │
│   │               Pod                      │                 │
│   │   ┌─────────────┐  ┌─────────────┐    │                 │
│   │   │   my-app    │  │   logger    │    │                 │
│   │   │ (container) │  │ (sidecar)   │    │                 │
│   │   └─────────────┘  └─────────────┘    │                 │
│   │                                        │                 │
│   │   Share: network (localhost), storage  │                 │
│   └───────────────────────────────────────┘                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Why Pods, not Containers?

| Feature | What Pod Provides |
|---------|-------------------|
| Shared networking | Containers in a pod share localhost |
| Shared storage | Can mount the same volume |
| Lifecycle | Containers start/stop together |
| Scheduling unit | K8s schedules pods, not containers |
| Co-location | Guaranteed to run on same node |

### Common Sidecar Patterns

```text
┌─────────────────────────────────────────────────────────────┐
│                   SIDECAR PATTERNS                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   Log collector:                                             │
│   ┌─────────────────────────────────────────┐               │
│   │  [App] ──logs──▶ [Fluentd sidecar]     │               │
│   │                        │                 │               │
│   │                        ▼                 │               │
│   │                 External logging         │               │
│   └─────────────────────────────────────────┘               │
│                                                              │
│   Proxy/Service mesh:                                        │
│   ┌─────────────────────────────────────────┐               │
│   │  Traffic ──▶ [Envoy proxy] ──▶ [App]   │               │
│   │              (handles TLS, retry, etc)  │               │
│   └─────────────────────────────────────────┘               │
│                                                              │
│   Config reloader:                                           │
│   ┌─────────────────────────────────────────┐               │
│   │  [Config watcher] ──signal──▶ [App]    │               │
│   │   (watches ConfigMap changes)           │               │
│   └─────────────────────────────────────────┘               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## How It All Works Together

When you run `kubectl apply -f deployment.yaml`:

```text
┌─────────────────────────────────────────────────────────────┐
│                    REQUEST FLOW                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   1. You: kubectl apply -f deployment.yaml                  │
│              │                                               │
│              ▼                                               │
│   2. API Server: Validates, authenticates, stores in etcd   │
│              │                                               │
│              ▼                                               │
│   3. Controller Manager: "3 replicas needed, 0 exist"       │
│              │            Creates 3 pod objects             │
│              ▼                                               │
│   4. Scheduler: "Pod 1 → Node A, Pod 2 → Node B..."        │
│              │   Assigns nodes to pods                      │
│              ▼                                               │
│   5. kubelet (on each node): "Start this container"         │
│              │                                               │
│              ▼                                               │
│   6. Container Runtime: Actually runs the container         │
│              │                                               │
│              ▼                                               │
│   7. kubelet: Reports back "Pod is Running"                 │
│              │                                               │
│              ▼                                               │
│   8. You: kubectl get pods → Shows 3/3 Running              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Local vs Cloud Kubernetes

| Aspect | Local (kind) | Cloud (EKS/GKE/AKS) |
|--------|--------------|---------------------|
| Control Plane | Runs in Docker container | Managed by cloud provider |
| Worker Nodes | Docker containers | Real VMs |
| Cost | Free | $73+/month |
| Use For | Learning, development | Production |
| Setup | Minutes | 15-20 minutes |
| Scaling | Limited by laptop | Virtually unlimited |

For this course, we use **kind** (Kubernetes IN Docker) locally, then deploy to AWS EKS in Chapter 10.

---

## Key Terms Summary

| Term | Meaning |
|------|---------|
| **Cluster** | The whole K8s system (control plane + nodes) |
| **Control Plane** | Brain of K8s (API Server, Scheduler, etc.) |
| **Node** | A machine (VM or physical) that runs pods |
| **Pod** | Smallest deployable unit (wraps containers) |
| **kubelet** | Agent on each node, manages pods |
| **kubectl** | CLI tool to talk to K8s |
| **etcd** | Database storing all cluster state |
| **Container Runtime** | Software that runs containers (containerd) |

---

## Check Your Understanding

Before moving on, make sure you can answer:

- [ ] What are the 4 Control Plane components and their roles?
- [ ] What's the difference between a Pod and a Container?
- [ ] What does the Scheduler do vs what does kubelet do?
- [ ] Where is cluster state stored?
- [ ] What is a sidecar container?

---

**Next:** [0.3 Containers 101](./0.3_containers_101.md)
