# 0.2a Explore the API Server

> The front door to Kubernetes - every request goes through it

---

## What is the API Server?

The API Server (`kube-apiserver`) is the **only component that talks to etcd**. Everything else talks through it.

```text
┌─────────────────────────────────────────────────────────────────┐
│                    API SERVER                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   kubectl ─────┐                                                │
│                │                                                │
│   Dashboard ───┼────▶ [API Server] ────▶ etcd                   │
│                │           │                                    │
│   Your apps ───┘           │                                    │
│                            ▼                                    │
│                    Scheduler, Controllers,                      │
│                    kubelets all watch here                      │
│                                                                 │
│   It's a REST API:                                              │
│   • GET    /api/v1/pods           → List pods                   │
│   • POST   /api/v1/namespaces/default/pods → Create pod         │
│   • DELETE /api/v1/namespaces/default/pods/nginx → Delete pod   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Hands-On: Find the API Server

### Step 1: See the API Server Pod

```bash
# Find the API server pod
kubectl get pods -n kube-system | grep apiserver
```

Output:
```text
kube-apiserver-playground-control-plane   1/1     Running   ...
```

### Step 2: Get Details

```bash
# Describe it
kubectl describe pod kube-apiserver-playground-control-plane -n kube-system
```

Notice:
- It runs on the control-plane node
- It listens on port 6443 (HTTPS)
- It has many command-line flags configuring security, etcd connection, etc.

---

## Hands-On: Talk to the API Server Directly

kubectl is just a fancy HTTP client. Let's see the raw API.

### Step 1: Start a Proxy

```bash
# Start a local proxy to the API server (handles auth for us)
kubectl proxy --port=8080 &
```

### Step 2: Make Raw API Calls

```bash
# List all pods (same as kubectl get pods)
curl http://localhost:8080/api/v1/pods | head -50

# List pods in default namespace
curl http://localhost:8080/api/v1/namespaces/default/pods

# Get cluster info
curl http://localhost:8080/api/v1

# List all API resources available
curl http://localhost:8080/apis
```

### Step 3: Create a Pod via API

```bash
# Create a pod using curl (same as kubectl run)
curl -X POST http://localhost:8080/api/v1/namespaces/default/pods \
  -H "Content-Type: application/json" \
  -d '{
    "apiVersion": "v1",
    "kind": "Pod",
    "metadata": {
      "name": "api-test-pod"
    },
    "spec": {
      "containers": [{
        "name": "nginx",
        "image": "nginx:alpine"
      }]
    }
  }'
```

### Step 4: Verify It Worked

```bash
# Check with kubectl
kubectl get pods

# Check via API
curl http://localhost:8080/api/v1/namespaces/default/pods/api-test-pod
```

### Step 5: Delete via API

```bash
# Delete the pod
curl -X DELETE http://localhost:8080/api/v1/namespaces/default/pods/api-test-pod

# Verify
kubectl get pods
```

### Step 6: Stop the Proxy

```bash
# Kill the proxy (find and kill the background job)
pkill -f "kubectl proxy"
```

---

## Hands-On: See What kubectl Actually Does

kubectl has a verbose mode that shows API calls:

```bash
# Create a pod with verbose output (shows the API call)
kubectl run nginx-verbose --image=nginx:alpine -v=6

# Even more verbose (shows request/response bodies)
kubectl get pods -v=8
```

You'll see output like:
```text
I0116 10:00:00.000000   12345 round_trippers.go:466] curl -k -v -XGET
  'https://127.0.0.1:6443/api/v1/namespaces/default/pods?limit=500'
```

**This proves:** kubectl is just making HTTP calls to the API server!

```bash
# Clean up
kubectl delete pod nginx-verbose
```

---

## Hands-On: API Server Authentication

The API server authenticates every request. Let's see how.

### Step 1: Check Your Identity

```bash
# Who am I to the cluster?
kubectl auth whoami
```

Output:
```text
ATTRIBUTE   VALUE
Username    kubernetes-admin
Groups      [system:masters system:authenticated]
```

### Step 2: Try Without Auth

```bash
# Try to access API server directly without proxy
# (This will fail - no credentials)
curl -k https://localhost:6443/api/v1/pods
```

Output:
```text
{
  "kind": "Status",
  "status": "Failure",
  "message": "Unauthorized",
  "code": 401
}
```

The proxy worked because it used your kubeconfig credentials automatically.

### Step 3: See Your Kubeconfig

```bash
# Your credentials are stored here
cat ~/.kube/config
```

This file contains:
- **clusters** - API server URLs and CA certificates
- **users** - Client certificates or tokens
- **contexts** - Which user talks to which cluster

---

## Hands-On: Watch API Server Logs

```bash
# See what the API server is doing
kubectl logs kube-apiserver-playground-control-plane -n kube-system | tail -20

# Watch in real-time (in another terminal)
kubectl logs -f kube-apiserver-playground-control-plane -n kube-system
```

Now in another terminal, create a pod and watch the API server logs react:
```bash
kubectl run log-test --image=nginx:alpine
kubectl delete pod log-test
```

---

## Hands-On: API Resources

The API server exposes many resource types:

```bash
# List all resource types
kubectl api-resources

# List with more info
kubectl api-resources -o wide
```

Output (partial):
```text
NAME              SHORTNAMES   KIND          NAMESPACED   VERBS
pods              po           Pod           true         create,delete,get,list,patch,update,watch
services          svc          Service       true         create,delete,get,list,patch,update,watch
deployments       deploy       Deployment    true         create,delete,get,list,patch,update,watch
nodes             no           Node          false        get,list,watch
namespaces        ns           Namespace     false        create,delete,get,list,patch,update,watch
```

Notice:
- **SHORTNAMES** - `po` for pods, `svc` for services
- **NAMESPACED** - Some resources are per-namespace, some are cluster-wide
- **VERBS** - What operations are allowed

---

## Experiment: What Happens If API Server Dies?

**WARNING: This will temporarily break your cluster. It recovers automatically.**

```bash
# Check current state
kubectl get pods -A

# "Kill" the API server by scaling it down... wait, you can't!
# The API server is a static pod - managed by kubelet directly
# Let's see where it's defined

# SSH into the control plane node
docker exec -it playground-control-plane bash
# or with podman:
podman exec -it playground-control-plane bash

# Inside the container:
cat /etc/kubernetes/manifests/kube-apiserver.yaml

# Exit
exit
```

The API server is a **static pod** - kubelet watches `/etc/kubernetes/manifests/` and automatically restarts anything there. This is how K8s bootstraps itself!

---

## Key Takeaways

1. **Everything goes through API Server** - kubectl, dashboards, internal components
2. **It's just a REST API** - GET, POST, PUT, DELETE over HTTPS
3. **Authentication required** - Certificates, tokens, or proxy
4. **It's the only thing that talks to etcd** - Single source of truth
5. **Static pod** - Managed by kubelet, auto-restarts if it crashes

---

## Quick Reference

```bash
# See API server
kubectl get pods -n kube-system | grep apiserver

# Describe it
kubectl describe pod kube-apiserver-playground-control-plane -n kube-system

# View logs
kubectl logs kube-apiserver-playground-control-plane -n kube-system

# Start local proxy
kubectl proxy --port=8080 &

# Raw API call
curl http://localhost:8080/api/v1/pods

# Verbose kubectl
kubectl get pods -v=8

# Check identity
kubectl auth whoami

# List API resources
kubectl api-resources
```

---

**Next:** [0.2b Explore etcd](./0.2b_explore_etcd.md)
