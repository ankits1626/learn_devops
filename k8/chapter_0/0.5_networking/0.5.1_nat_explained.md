# 0.5.1 NAT Explained

> Network Address Translation - how many devices share one IP

---

## What is NAT?

**NAT** (Network Address Translation) is a technique that modifies IP addresses as packets pass through a router or firewall.

Think of it like a **mail forwarding service**:
- Your devices have private addresses (apartment numbers)
- The router has one public address (building's street address)
- NAT translates between them

---

## The Problem NAT Solves

```text
┌─────────────────────────────────────────────────────────────────┐
│                    THE PROBLEM                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   IPv4 addresses: ~4.3 billion total                            │
│   (0.0.0.0 to 255.255.255.255)                                  │
│                                                                 │
│   World population: 8+ billion people                           │
│   Connected devices: 15+ billion                                │
│                                                                 │
│   Math problem: 15 billion devices ÷ 4 billion IPs = NOT ENOUGH │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   Solution: Let many devices SHARE one public IP!               │
│                                                                 │
│   Your home: 10+ devices (phones, laptops, TVs, etc.)           │
│   Your router: 1 public IP from your ISP                        │
│                                                                 │
│   NAT makes this sharing possible.                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## How NAT Works: Home Network Example

```text
┌─────────────────────────────────────────────────────────────────┐
│                    YOUR HOME NETWORK                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Your Devices (Private IPs)                                    │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│   │   Laptop    │  │   Phone     │  │   Smart TV  │             │
│   │192.168.1.10 │  │192.168.1.11 │  │192.168.1.12 │             │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│          │                │                │                    │
│          └────────────────┼────────────────┘                    │
│                           │                                     │
│                    ┌──────┴──────┐                              │
│                    │   Router    │                              │
│                    │   (NAT)     │                              │
│                    │             │                              │
│                    │ Inside:     │                              │
│                    │ 192.168.1.1 │                              │
│                    │             │                              │
│                    │ Outside:    │                              │
│                    │ 73.45.67.89 │  ← ONE public IP for ALL!    │
│                    └──────┬──────┘                              │
│                           │                                     │
└───────────────────────────┼─────────────────────────────────────┘
                            │
                       INTERNET
                            │
                    ┌───────┴───────┐
                    │   Google      │
                    │142.250.80.46  │
                    └───────────────┘

Private IPs (192.168.x.x) are NOT routable on the internet.
Only the router's public IP (73.45.67.89) can reach the internet.
```

---

## NAT Translation Step-by-Step

### Outgoing Traffic: Laptop → Google

```text
┌─────────────────────────────────────────────────────────────────┐
│           STEP 1: Laptop Sends a Request                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Laptop creates a packet:                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  SOURCE:      192.168.1.10:54321  (laptop's private IP) │   │
│   │  DESTINATION: 142.250.80.46:443   (google.com)          │   │
│   │  DATA:        "GET /search?q=kubernetes"                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   This packet goes to the router...                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│           STEP 2: Router Performs NAT                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Router rewrites the SOURCE address:                           │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  SOURCE:      73.45.67.89:12345   ← CHANGED!            │   │
│   │  DESTINATION: 142.250.80.46:443   (unchanged)           │   │
│   │  DATA:        "GET /search?q=kubernetes"                │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Router saves this mapping in its NAT table:                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  NAT TABLE                                              │   │
│   │  ─────────────────────────────────────────────────────  │   │
│   │  Public Port 12345  →  192.168.1.10:54321 (laptop)      │   │
│   │  Public Port 12346  →  192.168.1.11:8080  (phone)       │   │
│   │  ...                                                    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Now the packet can travel across the internet!                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Incoming Traffic: Google → Laptop

```text
┌─────────────────────────────────────────────────────────────────┐
│           STEP 3: Google Responds                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Google sends response to the public IP:                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  SOURCE:      142.250.80.46:443   (google)              │   │
│   │  DESTINATION: 73.45.67.89:12345   (router's public IP)  │   │
│   │  DATA:        "<html>Search results...</html>"          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Google doesn't know about 192.168.1.10 - only sees the router!│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│           STEP 4: Router Translates Back                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Router looks up port 12345 in NAT table:                      │
│   "Port 12345 → 192.168.1.10:54321"                             │
│                                                                 │
│   Router rewrites the DESTINATION:                              │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  SOURCE:      142.250.80.46:443   (unchanged)           │   │
│   │  DESTINATION: 192.168.1.10:54321  ← CHANGED BACK!       │   │
│   │  DATA:        "<html>Search results...</html>"          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Packet delivered to laptop!                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Visual Summary

```text
┌─────────────────────────────────────────────────────────────────┐
│                    NAT TRANSLATION                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   OUTGOING (laptop → internet):                                 │
│                                                                 │
│   192.168.1.10:54321  ───NAT───▶  73.45.67.89:12345             │
│   (private IP:port)              (public IP:port)               │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   INCOMING (internet → laptop):                                 │
│                                                                 │
│   73.45.67.89:12345  ───NAT───▶  192.168.1.10:54321             │
│   (public IP:port)               (private IP:port)              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Types of NAT

### 1. SNAT (Source NAT)

Changes the **source** IP. Used for outgoing traffic.

```text
┌─────────────────────────────────────────────────────────────────┐
│                         SNAT                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Private network → Internet                                    │
│                                                                 │
│   Before NAT:  src=192.168.1.10  dst=google.com                 │
│   After NAT:   src=73.45.67.89   dst=google.com                 │
│                ────────────────                                 │
│                Source changed!                                  │
│                                                                 │
│   Use case: Home/office networks accessing internet             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. DNAT (Destination NAT)

Changes the **destination** IP. Used for incoming traffic.

```text
┌─────────────────────────────────────────────────────────────────┐
│                         DNAT                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Internet → Private network                                    │
│                                                                 │
│   Before NAT:  src=client  dst=73.45.67.89:80                   │
│   After NAT:   src=client  dst=192.168.1.100:80                 │
│                            ────────────────────                 │
│                            Destination changed!                 │
│                                                                 │
│   Use case: Port forwarding to internal servers                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. PAT (Port Address Translation)

Also called **NAPT** or "NAT overload". Multiple devices share ONE public IP using different ports.

```text
┌─────────────────────────────────────────────────────────────────┐
│                         PAT                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Multiple devices → One public IP (different ports)            │
│                                                                 │
│   Laptop (192.168.1.10:54321)  →  73.45.67.89:12345             │
│   Phone  (192.168.1.11:8080)   →  73.45.67.89:12346             │
│   TV     (192.168.1.12:443)    →  73.45.67.89:12347             │
│                                   ─────────────────             │
│                                   Same IP, different ports!     │
│                                                                 │
│   This is what your home router does!                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## NAT in Kubernetes Context

Kubernetes networking principle: **Pods communicate WITHOUT NAT**.

### Why No NAT Between Pods?

```text
┌─────────────────────────────────────────────────────────────────┐
│                    WITH NAT (Problems)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Pod A (10.244.1.5) wants to call Pod B (10.244.2.3):          │
│                                                                 │
│   Pod A sends: src=10.244.1.5                                   │
│        │                                                        │
│        ▼ NAT                                                    │
│   Pod B sees:  src=10.96.0.1  ← Not the real source!            │
│                                                                 │
│   Problems:                                                     │
│   ✗ Pod B can't identify who's calling                          │
│   ✗ Logs show wrong source IPs (hard to debug)                  │
│   ✗ Some protocols need real IPs (will break)                   │
│   ✗ Network policies can't match on true source                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  WITHOUT NAT (Kubernetes Way)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Pod A (10.244.1.5) wants to call Pod B (10.244.2.3):          │
│                                                                 │
│   Pod A sends: src=10.244.1.5                                   │
│        │                                                        │
│        ▼ Direct routing                                         │
│   Pod B sees:  src=10.244.1.5  ← Real source IP!                │
│                                                                 │
│   Benefits:                                                     │
│   ✓ True source identification                                  │
│   ✓ Accurate logging and tracing                                │
│   ✓ All protocols work correctly                                │
│   ✓ Network policies can match real sources                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Where NAT IS Used in Kubernetes

NAT is still used when pods talk to the **outside world**:

```text
┌─────────────────────────────────────────────────────────────────┐
│              KUBERNETES EGRESS (Pod → Internet)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   INSIDE CLUSTER                    OUTSIDE CLUSTER             │
│   ┌─────────────────┐              ┌─────────────────┐          │
│   │  Pod            │              │  External API   │          │
│   │  10.244.1.5     │──── NAT ────▶│  api.stripe.com │          │
│   └─────────────────┘              └─────────────────┘          │
│                                                                 │
│   Pod's private IP (10.244.x.x) can't reach the internet.       │
│   Node performs SNAT to use its public/routable IP.             │
│                                                                 │
│   Stripe sees: Request from <node-public-ip>                    │
│   (not the pod's IP)                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Hands-On: See NAT on Your Mac

```bash
# See your Mac's network interfaces and IPs
ifconfig | grep "inet "

# See your router's NAT (if you have access)
# Usually at http://192.168.1.1 or http://192.168.0.1

# See outgoing connections and their local ports
netstat -an | grep ESTABLISHED
```

### See NAT in Kubernetes

```bash
# See the iptables NAT rules (inside a node)
# For kind cluster:
podman exec playground-control-plane iptables -t nat -L -n -v | head -50

# See MASQUERADE rules (SNAT for outgoing traffic)
podman exec playground-control-plane iptables -t nat -L POSTROUTING -n -v
```

---

## Real-World Analogy: Hotel Mail Room

```text
┌─────────────────────────────────────────────────────────────────┐
│                    HOTEL ANALOGY                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Hotel = Your network                                          │
│   Hotel address = Public IP (73.45.67.89)                       │
│   Room numbers = Private IPs (192.168.1.10, .11, .12)           │
│   Mail room = NAT router                                        │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   OUTGOING MAIL:                                                │
│                                                                 │
│   Guest in Room 110 sends letter to Amazon.                     │
│   Mail room changes return address:                             │
│     From: "Room 110, Hotel X"                                   │
│     To:   "Hotel X, 123 Main St" + tracking number              │
│                                                                 │
│   Amazon only sees the hotel's street address.                  │
│                                                                 │
│   ─────────────────────────────────────────────────────────     │
│                                                                 │
│   INCOMING MAIL:                                                │
│                                                                 │
│   Amazon sends package to "Hotel X, 123 Main St"                │
│   Mail room looks up tracking number → Room 110                 │
│   Delivers package to correct room.                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Key Takeaways

| Concept | Explanation |
|---------|-------------|
| **NAT** | Translates IP addresses between networks |
| **Purpose** | Share limited public IPs among many devices |
| **SNAT** | Changes source IP (outgoing traffic) |
| **DNAT** | Changes destination IP (incoming traffic) |
| **PAT** | Multiple devices share one IP via different ports |
| **Home router** | Does PAT - all your devices share one public IP |
| **Kubernetes** | No NAT between pods (direct communication) |
| **K8s egress** | Uses SNAT when pods reach external services |

---

## Quick Reference

```text
NAT Types:
├── SNAT (Source NAT)
│   └── Changes source IP
│   └── Used for: Internal → External
│
├── DNAT (Destination NAT)
│   └── Changes destination IP
│   └── Used for: Port forwarding, load balancing
│
└── PAT (Port Address Translation)
    └── Many devices share one IP (different ports)
    └── Used for: Home routers, corporate networks

Private IP Ranges (RFC 1918):
├── 10.0.0.0 - 10.255.255.255     (Class A)
├── 172.16.0.0 - 172.31.255.255   (Class B)
└── 192.168.0.0 - 192.168.255.255 (Class C)

These IPs are NOT routable on the internet - need NAT!
```

---

**Back to:** [0.5 Networking Basics](./0.5_networking_basics.md)
