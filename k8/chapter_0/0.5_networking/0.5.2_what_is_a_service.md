# What is a Service?

Now that you understand Deployments, let's understand why we need Services.

---

## The Problem: Pod IPs are Unreliable

When you create a deployment with 3 replicas, each pod gets its own IP:

```
┌─────────────────────────────────────────────────────────────┐
│                    Deployment: "web"                        │
│                                                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐       │
│   │   Pod 1     │   │   Pod 2     │   │   Pod 3     │       │
│   │   nginx     │   │   nginx     │   │   nginx     │       │
│   │ 10.244.1.10 │   │ 10.244.2.15 │   │ 10.244.1.22 │       │
│   └─────────────┘   └─────────────┘   └─────────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Three big problems:**

| Problem | Why it's bad |
|---------|--------------|
| **IPs are random** | You can't predict what IP a pod will get |
| **IPs change** | When a pod restarts, it gets a NEW IP |
| **Multiple IPs** | Which of the 3 IPs should clients use? |

---

## Real World Analogy: Phone Numbers

Imagine a company with 3 customer service agents:

```
WITHOUT a Service (Direct Pod IPs):
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Customer needs help. Which number to call?                │
│                                                             │
│   Agent 1: 555-0101  (might quit tomorrow)                  │
│   Agent 2: 555-0102  (might be busy)                        │
│   Agent 3: 555-0103  (might change desks)                   │
│                                                             │
│   Customer has to:                                          │
│   • Know all agent numbers                                  │
│   • Track when agents change                                │
│   • Decide who to call                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘

WITH a Service (Single Stable Endpoint):
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│   Customer calls: 1-800-HELP (stable, never changes)         │
│                        │                                     │
│                        ▼                                     │
│                 ┌─────────────┐                              │
│                 │ Receptionist│  ← This is the SERVICE       │
│                 │ (routes     │                              │
│                 │  calls)     │                              │
│                 └─────────────┘                              │
│                   /    |    \                                │
│                  ▼     ▼     ▼                               │
│               Agent  Agent  Agent                            │
│                 1      2      3                              │
│                                                              │
│   Customer only needs ONE number                             │
│   Receptionist handles routing                               │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**A Kubernetes Service is the receptionist.**

---

## What is a Service?

A **Service** is a stable network endpoint that routes traffic to pods.

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│                     SERVICE: "web"                           │
│                  ClusterIP: 10.96.45.123                     │
│                      Port: 80                                │
│                                                              │
│   This IP NEVER changes, even if pods die and restart        │
│                                                              │
│                         │                                    │
│            ┌────────────┼────────────┐                       │
│            │            │            │                       │
│            ▼            ▼            ▼                       │
│       ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│       │  Pod 1  │  │  Pod 2  │  │  Pod 3  │                  │
│       │10.244.  │  │10.244.  │  │10.244.  │                  │
│       │  1.10   │  │  2.15   │  │  1.22   │                  │
│       └─────────┘  └─────────┘  └─────────┘                  │
│                                                              │
│       Pod IPs may change. Service IP stays the same.         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## Creating a Service

```bash
# First, create a deployment
kubectl create deployment web --image=nginx --replicas=3

# Then, expose it as a service
kubectl expose deployment web --port=80
```

**What `kubectl expose` does:**
1. Creates a Service named "web"
2. Assigns it a stable ClusterIP (e.g., 10.96.45.123)
3. Finds all pods with label `app=web`
4. Routes traffic to those pods

---

## How Does the Service Find Pods?

Services use **labels** to select pods.

```
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│   Service: "web"                                             │
│   Selector: app=web    ◄─── "Find pods with this label"      │
│                                                              │
│   ┌──────────────────────────────────────────────────────┐   │
│   │                                                      │   │
│   │   Pod 1              Pod 2              Pod 3        │   │
│   │   labels:            labels:            labels:      │   │
│   │     app: web ✓         app: web ✓         app: web ✓ │   │
│   │                                                      │   │
│   │   All matched! All receive traffic.                  │   │
│   │                                                      │   │
│   └──────────────────────────────────────────────────────┘   │
│                                                              │
│   ┌──────────────────────────────────────────────────────┐   │
│   │                                                      │   │
│   │   Pod 4                                              │   │
│   │   labels:                                            │   │
│   │     app: database ✗                                  │   │
│   │                                                      │   │
│   │   NOT matched. Does NOT receive traffic.             │   │
│   │                                                      │   │
│   └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

When you create a deployment named "web", pods automatically get the label `app=web`.

---

## Service Types

There are different types of Services for different use cases:

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   ClusterIP (default)                                       │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  • Only accessible from INSIDE the cluster          │   │
│   │  • Gets a virtual IP like 10.96.x.x                 │   │
│   │  • Use case: internal services (databases, caches)  │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   NodePort                                                  │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  • Accessible from OUTSIDE via node IP + port       │   │
│   │  • Opens a port (30000-32767) on every node         │   │
│   │  • Use case: development, simple external access    │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   LoadBalancer                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  • Gets an EXTERNAL IP from cloud provider          │   │
│   │  • Creates a cloud load balancer (AWS ELB, etc.)    │   │
│   │  • Use case: production external traffic            │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

For this example, we use **ClusterIP** (the default).

---

## Viewing Your Service

```bash
kubectl get svc web
```

Output:
```
NAME   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
web    ClusterIP   10.96.45.123   <none>        80/TCP    5s
```

| Column | Meaning |
|--------|---------|
| `NAME` | Service name |
| `TYPE` | ClusterIP (internal only) |
| `CLUSTER-IP` | The stable virtual IP |
| `EXTERNAL-IP` | None (not exposed outside) |
| `PORT(S)` | Port 80, TCP protocol |

---

## How Does Routing Actually Work?

Behind the scenes, **kube-proxy** makes the magic happen.

```
┌──────────────────────────────────────────────────────────────┐
│                         NODE                                 │
│                                                              │
│   ┌──────────────────────────────────────────────────────┐   │
│   │                    kube-proxy                        │   │
│   │                                                      │   │
│   │   Watches for Service changes                        │   │
│   │   Programs iptables/ipvs rules                       │   │
│   │                                                      │   │
│   │   Rule: If destination = 10.96.45.123:80             │   │
│   │         Then DNAT to one of:                         │   │
│   │           → 10.244.1.10:80 (Pod 1)                   │   │
│   │           → 10.244.2.15:80 (Pod 2)                   │   │
│   │           → 10.244.1.22:80 (Pod 3)                   │   │
│   │                                                      │   │
│   └──────────────────────────────────────────────────────┘   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**Key insight:** The ClusterIP (10.96.45.123) is a **virtual IP**. No network interface has this IP. It only exists in iptables rules.

---

## Load Balancing

Services automatically load balance across pods:

```
Request 1  ────►  Service  ────►  Pod 1
Request 2  ────►  Service  ────►  Pod 3
Request 3  ────►  Service  ────►  Pod 2
Request 4  ────►  Service  ────►  Pod 1
Request 5  ────►  Service  ────►  Pod 3
```

By default, it uses **round-robin** distribution.

---

## The ClusterIP Problem

ClusterIP services are only accessible from **inside** the cluster.

```
┌─────────────────────────────────────────────────────────────┐
│                   KUBERNETES CLUSTER                        │
│                                                             │
│     ┌──────────────┐        ┌──────────────────────────┐    │
│     │  Your Pod    │ ─────► │  Service: 10.96.45.123   │    │
│     │  (inside)    │   ✓    │        WORKS!            │    │
│     └──────────────┘        └──────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                    YOUR LAPTOP                               │
│                                                              │
│     curl 10.96.45.123                                        │
│            │                                                 │
│            └────► ✗ FAILS! IP not routable from here         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**That's why in the example, we create a test pod inside the cluster.**

---

## Summary

| Concept | What it does |
|---------|--------------|
| **Service** | Provides stable IP and DNS name for a group of pods |
| **ClusterIP** | Virtual IP accessible only inside cluster |
| **Selector** | Labels used to find which pods to route to |
| **kube-proxy** | Programs network rules for routing |
| **Load balancing** | Distributes requests across pods |

---

## What's Next?

Now you understand:
- ✓ What a Deployment is
- ✓ What a Service is

Next, let's understand **DNS and Service Discovery** - how you can access a service by name instead of IP.

See: [0.5.3_coredns_and_service_discovery.md](./0.5.3_coredns_and_service_discovery.md)
