# 0.6c kind Basics

> Understanding kind before we create clusters

---

## What is kind?

**kind** = **K**ubernetes **IN** **D**ocker (or Podman)

It creates real Kubernetes clusters using containers as "nodes" instead of VMs.

```text
┌─────────────────────────────────────────────────────────────────┐
│                    WHAT KIND DOES                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Traditional K8s cluster:          kind cluster:               │
│   ┌─────────────────────┐           ┌─────────────────────┐     │
│   │   Real VM (EC2)     │           │  Podman Container   │     │
│   │   4 vCPUs, 8GB RAM  │           │  Pretending to be   │     │
│   │   Full OS install   │           │  a "node"           │     │ 
│   │   Minutes to create │           │  Seconds to create  │     │
│   └─────────────────────┘           └─────────────────────┘     │
│                                                                 │
│   kind fakes nodes using containers.                            │
│   Kubernetes can't tell the difference!                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Why kind?

| Feature | kind | minikube | Docker Desktop K8s |
|---------|------|----------|-------------------|
| Multi-node clusters | Yes | Limited | No |
| Speed | Fast | Slower | Medium |
| Resource usage | Light | Heavier | Medium |
| CI/CD friendly | Yes | No | No |
| Works with Podman | Yes | Yes | No |
| Configuration | YAML file | CLI flags | GUI |

**kind is perfect for:**
- Learning Kubernetes locally
- Testing multi-node scenarios
- CI/CD pipelines
- Quick experiments

---

## How kind Works

```text
┌─────────────────────────────────────────────────────────────────┐
│                    KIND ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Your Mac                                                      │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Podman Machine (Linux VM)                              │   │
│   │  ┌───────────────────────────────────────────────────┐  │   │
│   │  │                                                   │  │   │
│   │  │  kind cluster "playground"                        │  │   │
│   │  │  ┌─────────────────────────────────────────────┐  │  │   │
│   │  │  │  Container: playground-control-plane        │  │  │   │
│   │  │  │  (Kubernetes control plane components)      │  │  │   │
│   │  │  │  API Server, Scheduler, etcd, etc.          │  │  │   │
│   │  │  └─────────────────────────────────────────────┘  │  │   │
│   │  │  ┌──────────────────┐  ┌──────────────────┐       │  │   │
│   │  │  │  Container:      │  │  Container:      │       │  │   │
│   │  │  │  playground-     │  │  playground-     │       │  │   │
│   │  │  │  worker          │  │  worker2         │       │  │   │
│   │  │  │  (Your pods run  │  │  (Your pods run  │       │  │   │
│   │  │  │   here)          │  │   here)          │       │  │   │
│   │  │  └──────────────────┘  └──────────────────┘       │  │   │
│   │  │                                                   │  │   │
│   │  └───────────────────────────────────────────────────┘  │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   Each "node" is a container running a full Kubernetes node     │
│   image (kindest/node), which can run pods inside it.           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Essential Commands

### Cluster Management

```bash
# Create a cluster (default name: "kind")
kind create cluster

# Create with a custom name
kind create cluster --name my-cluster

# Create from a config file
kind create cluster --name playground --config kind-config.yaml

# Create and wait for nodes to be ready
kind create cluster --name playground --config kind-config.yaml --wait 60s

# List all clusters
kind get clusters

# Delete a cluster
kind delete cluster --name playground

# Delete all clusters
kind delete clusters --all
```

### Working with Images

```bash
# Load a local image into the cluster
# (so you don't need to push to a registry)
kind load docker-image my-app:latest --name playground

# Load from a tar file
kind load image-archive my-app.tar --name playground
```

### Debugging

```bash
# Export logs from a cluster
kind export logs --name playground ./kind-logs

# Get kubeconfig for a cluster
kind get kubeconfig --name playground

# Check kind version
kind version
```

---

## Cluster Configuration

kind uses YAML files to configure clusters.

### Simple Single-Node Cluster

```yaml
# kind-simple.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
```

```bash
kind create cluster --config kind-simple.yaml
```

### Multi-Node Cluster (Recommended for Learning)

```yaml
# kind-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

nodes:
  # Control plane node
  - role: control-plane

  # Worker nodes
  - role: worker
  - role: worker
```

### With Port Mappings (Access Services from Browser)

```yaml
# kind-with-ports.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

nodes:
  - role: control-plane
    extraPortMappings:
      # Map host port 30000 to node port 30000
      - containerPort: 30000
        hostPort: 30000
        protocol: TCP
      # Map host port 80 to node port 80
      - containerPort: 80
        hostPort: 80
        protocol: TCP
  - role: worker
  - role: worker
```

**Why port mappings?**
```text
Without port mapping:
  Browser → localhost:30000 → ??? (can't reach cluster)

With port mapping:
  Browser → localhost:30000 → kind node:30000 → Your service
```

### With Ingress Ready

```yaml
# kind-ingress.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      - containerPort: 443
        hostPort: 443
        protocol: TCP
  - role: worker
  - role: worker
```

### High Availability (Multiple Control Planes)

```yaml
# kind-ha.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

nodes:
  - role: control-plane
  - role: control-plane
  - role: control-plane
  - role: worker
  - role: worker
  - role: worker
```

---

## Common Patterns

### Pattern 1: Development Cluster

Quick cluster for testing:

```bash
# Create
kind create cluster --name dev

# Use it
kubectl config use-context kind-dev
kubectl get nodes

# Done? Delete it
kind delete cluster --name dev
```

### Pattern 2: Persistent Learning Cluster

Keep this cluster around:

```yaml
# ~/k8s-playground/kind-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    extraPortMappings:
      - containerPort: 30000
        hostPort: 30000
      - containerPort: 30001
        hostPort: 30001
  - role: worker
  - role: worker
```

```bash
# Create once
kind create cluster --name playground --config kind-config.yaml --wait 60s

# Recreate if needed (cluster persists when Podman stops)
kind delete cluster --name playground
kind create cluster --name playground --config kind-config.yaml --wait 60s
```

### Pattern 3: Testing Local Images

Build locally, test in kind without pushing to registry:

```bash
# Build your image
podman build -t my-app:v1 .

# Load into kind
kind load docker-image my-app:v1 --name playground

# Now use it in a pod
kubectl run my-app --image=my-app:v1
```

---

## kind + Podman Setup

kind needs to know to use Podman instead of Docker.

### Option 1: Environment Variable (Recommended)

```bash
# Add to ~/.zshrc
export KIND_EXPERIMENTAL_PROVIDER=podman
```

### Option 2: Per-Command

```bash
KIND_EXPERIMENTAL_PROVIDER=podman kind create cluster
```

### Requirements for Podman

```bash
# Podman machine must be rootful
podman machine init --rootful --cpus 4 --memory 4096

# Or set existing machine to rootful
podman machine set --rootful

# Start the machine
podman machine start
```

---

## Contexts and kubectl

When you create a kind cluster, it automatically sets up kubectl context.

```bash
# See all contexts
kubectl config get-contexts

# Output:
# CURRENT   NAME              CLUSTER
# *         kind-playground   kind-playground
#           kind-dev          kind-dev

# Switch context
kubectl config use-context kind-playground

# Or use kubectx (if installed)
kubectx kind-playground
```

The naming convention is `kind-<cluster-name>`.

---

## Troubleshooting

### Cluster Creation Fails

```bash
# Check Podman is running
podman machine list

# Check rootful mode
podman machine inspect | grep -i rootful
# Should show: "Rootful": true

# Check KIND_EXPERIMENTAL_PROVIDER is set
echo $KIND_EXPERIMENTAL_PROVIDER
# Should show: podman
```

### Nodes Not Ready

```bash
# Check node status
kubectl get nodes

# If NotReady, check events
kubectl describe node <node-name>

# Or check kind container logs
podman logs playground-control-plane
```

### Can't Pull Images Inside Cluster

```bash
# Test network from inside a kind node
podman exec playground-control-plane ping -c 2 google.com

# If DNS fails, check Podman's DNS
podman machine ssh cat /etc/resolv.conf
```

### Cluster Disappeared After Podman Restart

The cluster containers should persist:

```bash
# Check if containers exist
podman ps -a | grep playground

# If they exist but stopped, start Podman machine
podman machine start

# Then check kubectl
kubectl get nodes

# If containers don't exist, recreate cluster
kind create cluster --name playground --config kind-config.yaml
```

### Out of Disk Space

```bash
# Check Podman disk usage
podman system df

# Clean up unused images and containers
podman system prune -a

# If persistent, increase Podman machine disk
podman machine stop
podman machine rm
podman machine init --rootful --cpus 4 --memory 4096 --disk-size 100
podman machine start
```

---

## Quick Reference

```text
┌─────────────────────────────────────────────────────────────────┐
│                    KIND QUICK REFERENCE                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Create:                                                        │
│    kind create cluster --name <name>                            │
│    kind create cluster --name <name> --config <file>            │
│    kind create cluster --name <name> --config <file> --wait 60s │
│                                                                 │
│  List:                                                          │
│    kind get clusters                                            │
│                                                                 │
│  Delete:                                                        │
│    kind delete cluster --name <name>                            │
│    kind delete clusters --all                                   │
│                                                                 │
│  Images:                                                        │
│    kind load docker-image <image> --name <cluster>              │
│                                                                 │
│  Debug:                                                         │
│    kind export logs --name <cluster> <output-dir>               │
│                                                                 │
│  Context naming: kind-<cluster-name>                            │
│    kubectl config use-context kind-playground                   │
│                                                                 │
│  Required for Podman:                                           │
│    export KIND_EXPERIMENTAL_PROVIDER=podman                     │
│    Podman machine must be rootful                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Comparison: kind vs Real Cluster

| Aspect | kind | Production (EKS/GKE/AKS) |
|--------|------|--------------------------|
| Nodes | Containers | Real VMs |
| Networking | Simulated | Real cloud networking |
| Storage | Local only | Cloud storage (EBS, etc.) |
| Load Balancer | NodePort only | Cloud LB |
| Creation time | Seconds | Minutes |
| Cost | Free | $$$  |
| Use case | Learning, testing | Production workloads |

**The Kubernetes API and concepts are identical.** What you learn on kind transfers directly to production clusters.

---

**Back to:** [0.6 Mac Setup](./0.6_mac_setup.md) | **Next:** [0.7 Your First Cluster](./0.7_first_cluster.md)
